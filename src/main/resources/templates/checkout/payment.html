<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/main-layout}">
<head>
    <title>Phương thức thanh toán - Thanh toán</title>
    <style>
        .checkout-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        
        .checkout-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .checkout-steps:before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 1;
        }
        
        .step {
            position: relative;
            z-index: 2;
            background-color: #fff;
            padding: 0 10px;
            text-align: center;
        }
        
        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
        }
        
        .step.active .step-icon {
            background-color: #0e7c7b;
            color: #fff;
        }
        
        .step.completed .step-icon {
            background-color: #28a745;
            color: #fff;
        }
        
        .step-title {
            font-size: 14px;
            color: #666;
        }
        
        .step.active .step-title {
            color: #0e7c7b;
            font-weight: 600;
        }
        
        .step.completed .step-title {
            color: #28a745;
        }
        
        .btn-primary {
            background-color: #0e7c7b;
            border-color: #0e7c7b;
        }
        
        .btn-primary:hover {
            background-color: #085b5a;
            border-color: #085b5a;
        }
        
        .btn-outline-primary {
            color: #0e7c7b;
            border-color: #0e7c7b;
        }
        
        .btn-outline-primary:hover {
            background-color: #0e7c7b;
            border-color: #0e7c7b;
            color: white;
        }
        
        .checkout-section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .checkout-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .payment-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .payment-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .payment-card.selected {
            border: 2px solid #0e7c7b;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
        }
        
        .payment-radio {
            margin-right: 15px;
        }
        
        .payment-details {
            flex-grow: 1;
        }
        
        .payment-icon {
            font-size: 24px;
            margin-right: 15px;
            color: #0e7c7b;
        }
        
        .payment-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .payment-description {
            color: #666;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .selected-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .order-summary {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        
        .order-summary-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .order-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .order-summary-label {
            color: #666;
        }
        
        .order-summary-value {
            font-weight: 600;
            color: #333;
        }
        
        .order-summary-total {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .order-summary-total-label {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }
        
        .order-summary-total-value {
            font-weight: 700;
            color: #0e7c7b;
            font-size: 1.2rem;
        }
        
        .preview-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .preview-title {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-content {
            color: #666;
        }
        
        .preview-action {
            color: #0e7c7b;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
        }
        
        .preview-action:hover {
            text-decoration: underline;
        }
        
        /* Credit card form styles */
        .card-form {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            display: none;
        }
        
        .card-form.active {
            display: block;
        }
        
        .card-form .form-group {
            margin-bottom: 15px;
        }
        
        .card-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .card-form .card-number-field {
            display: flex;
        }
        
        .card-form .card-icon {
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 24px;
        }
        
        .expiry-and-cvv {
            display: flex;
            gap: 15px;
        }
        
        .expiry-and-cvv > div {
            flex: 1;
        }
    </style>
</head>
<body>
    <main layout:fragment="content">
        <div class="container mt-4">
            <div class="row">
                <div class="col-12">
                    <div class="page-header">
                        <h1>Thanh toán</h1>
                        <p>Vui lòng hoàn tất thông tin mua hàng</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="checkout-container">
                <!-- Checkout Steps -->
                <div class="checkout-steps">
                    <div class="step completed">
                        <div class="step-icon">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="step-title">Địa chỉ</div>
                    </div>
                    <div class="step completed">
                        <div class="step-icon">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="step-title">Vận chuyển</div>
                    </div>
                    <div class="step active">
                        <div class="step-icon">3</div>
                        <div class="step-title">Thanh toán</div>
                    </div>
                    <div class="step">
                        <div class="step-icon">4</div>
                        <div class="step-title">Xác nhận</div>
                    </div>
                </div>

                <!-- Alert Messages -->
                <div th:replace="fragments/messages :: flash-messages"></div>

                <div class="row">
                    <div class="col-lg-8">
                        <!-- Selected Address Preview -->
                        <div class="preview-section">
                            <div class="preview-title">
                                Địa chỉ giao hàng
                                <a th:href="@{/checkout/address}" class="preview-action">Thay đổi</a>
                            </div>
                            <div class="preview-content">
                                <div th:text="${customer.fullName}">Họ tên người nhận</div>
                                <div th:text="${shippingAddress.addressLine}">123 Đường Láng</div>
                                <div th:text="${shippingAddress.city + ', ' + shippingAddress.country}">Hà Nội, Việt Nam</div>
                                <div th:if="${shippingAddress.zipCode}" th:text="${'Mã bưu điện: ' + shippingAddress.zipCode}">Mã bưu điện: 100000</div>
                            </div>
                        </div>

                        <!-- Selected Shipping Method Preview -->
                        <div class="preview-section">
                            <div class="preview-title">
                                Phương thức vận chuyển
                                <a th:href="@{/checkout/shipping}" class="preview-action">Thay đổi</a>
                            </div>
                            <div class="preview-content" th:if="${shippingMethod != null}">
                                <div class="d-flex justify-content-between">
                                    <span th:text="${shippingMethod.name + ' (' + shippingMethod.estimatedDeliveryTime + ')'}">
                                        Giao hàng tiêu chuẩn (2-3 ngày làm việc)
                                    </span>
                                    <span th:text="${#numbers.formatDecimal(shippingMethod.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">
                                        30.000 VNĐ
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method Selection -->
                        <div class="checkout-section">
                            <h3 class="checkout-section-title">Phương thức thanh toán</h3>
                            
                            <form id="paymentMethodForm" th:action="@{/checkout/select-payment}" method="post">
                                <input type="hidden" id="selectedPaymentMethod" name="paymentMethodId" value="">
                                
                                <!-- Payment Method Options -->
                                <!-- Lấy danh sách các phương thức thanh toán từ cơ sở dữ liệu để người dùng chọn -->
                                <div th:if="${paymentMethods != null and !paymentMethods.empty}">
                                    <div th:each="method : ${paymentMethods}" th:id="'payment-card-' + ${method.paymentMethodId}" 
                                        class="payment-card" 
                                        th:data-method-id="${method.paymentMethodId}"
                                        onclick="selectPaymentMethod(this, this.getAttribute('data-method-id'))">
                                        <div class="payment-option">
                                            <div class="payment-radio">
                                                <input type="radio" th:id="'payment-' + ${method.paymentMethodId}" name="payment" 
                                                       th:value="${method.paymentMethodId}" class="form-check-input">
                                            </div>
                                            <div class="payment-icon">
                                                <i th:class="${method.provider == 'Visa'} ? 'far fa-credit-card' : 
                                                              ${method.provider == 'MOMO'} ? 'fas fa-wallet' : 
                                                              ${method.methodName == 'Tiền mặt'} ? 'fas fa-money-bill-wave' :
                                                              'fas fa-university'"></i>
                                            </div>
                                            <div class="payment-details">
                                                <div class="payment-name" th:text="${method.methodName}">Phương thức thanh toán</div>
                                                <div class="payment-description" th:text="${method.description}">Mô tả phương thức thanh toán</div>
                                                <div class="payment-description" th:if="${method.accountNumber != null}" th:text="${method.accountNumber}">Số tài khoản</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Các phương thức thanh toán mặc định nếu không có phương thức nào trong cơ sở dữ liệu -->
                                <div th:if="${paymentMethods == null or paymentMethods.empty}">
                                    <div id="payment-card-cod" class="payment-card" onclick="selectPaymentMethod(this, 'cod')">
                                        <div class="payment-option">
                                            <div class="payment-radio">
                                                <input type="radio" id="payment-cod" name="payment" value="cod" class="form-check-input">
                                            </div>
                                            <div class="payment-icon">
                                                <i class="fas fa-money-bill-wave"></i>
                                            </div>
                                            <div class="payment-details">
                                                <div class="payment-name">Thanh toán khi nhận hàng (COD)</div>
                                                <div class="payment-description">Thanh toán bằng tiền mặt khi nhận hàng</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="payment-card-bank" class="payment-card" onclick="selectPaymentMethod(this, 'bank')">
                                        <div class="payment-option">
                                            <div class="payment-radio">
                                                <input type="radio" id="payment-bank" name="payment" value="bank" class="form-check-input">
                                            </div>
                                            <div class="payment-icon">
                                                <i class="fas fa-university"></i>
                                            </div>
                                            <div class="payment-details">
                                                <div class="payment-name">Chuyển khoản ngân hàng</div>
                                                <div class="payment-description">Thanh toán bằng chuyển khoản ngân hàng</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Bank Transfer Details - Hidden by default, shown when selected -->
                                        <div id="bank-details" class="card-form">
                                            <div class="alert alert-info">
                                                <p class="mb-1"><strong>Thông tin tài khoản:</strong></p>
                                                <p class="mb-1">Ngân hàng: <strong>Vietcombank</strong></p>
                                                <p class="mb-1">Số tài khoản: <strong>1234567890</strong></p>
                                                <p class="mb-1">Chủ tài khoản: <strong>CÔNG TY TNHH THE SOURVENIR</strong></p>
                                                <p class="mb-0">Nội dung: <strong>Thanh toán đơn hàng + [Số điện thoại của bạn]</strong></p>
                                            </div>
                                            <p class="small text-muted">Lưu ý: Đơn hàng của bạn sẽ được xử lý sau khi chúng tôi nhận được thanh toán.</p>
                                        </div>
                                    </div>
                                    
                                    <div id="payment-card-credit" class="payment-card" onclick="selectPaymentMethod(this, 'credit')">
                                        <div class="payment-option">
                                            <div class="payment-radio">
                                                <input type="radio" id="payment-credit" name="payment" value="credit" class="form-check-input">
                                            </div>
                                            <div class="payment-icon">
                                                <i class="far fa-credit-card"></i>
                                            </div>
                                            <div class="payment-details">
                                                <div class="payment-name">Thẻ tín dụng/Ghi nợ</div>
                                                <div class="payment-description">Thanh toán an toàn bằng thẻ tín dụng hoặc thẻ ghi nợ</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Credit Card Form - Hidden by default, shown when selected -->
                                        <div id="credit-card-form" class="card-form">
                                            <div class="form-group position-relative">
                                                <label for="card-number">Số thẻ</label>
                                                <input type="text" class="form-control" id="card-number" name="cardNumber" placeholder="XXXX XXXX XXXX XXXX" required>
                                                <span class="card-icon"><i class="fab fa-cc-visa"></i></span>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label for="card-first-name">Tên (First Name)</label>
                                                        <input type="text" class="form-control" id="card-first-name" name="cardFirstName" placeholder="First Name" required>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label for="card-last-name">Họ (Last Name)</label>
                                                        <input type="text" class="form-control" id="card-last-name" name="cardLastName" placeholder="Last Name" required>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="expiry-and-cvv">
                                                <div class="form-group">
                                                    <label for="expiry-date">Ngày hết hạn</label>
                                                    <input type="text" class="form-control" id="expiry-date" name="cardExpiryDate" placeholder="MM/YY" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="cvv">Mã bảo mật (CVV)</label>
                                                    <input type="text" class="form-control" id="cvv" name="cardCVC" placeholder="123" required>
                                                </div>
                                            </div>
                                            <!-- Đã bỏ checkbox "Lưu thông tin thẻ cho lần thanh toán sau" vì hệ thống sẽ tự động lưu -->
                                        </div>
                                    </div>
                                    
                                    <div id="payment-card-momo" class="payment-card" onclick="selectPaymentMethod(this, 'momo')">
                                        <div class="payment-option">
                                            <div class="payment-radio">
                                                <input type="radio" id="payment-momo" name="payment" value="momo" class="form-check-input">
                                            </div>
                                            <div class="payment-icon">
                                                <i class="fas fa-wallet"></i>
                                            </div>
                                            <div class="payment-details">
                                                <div class="payment-name">Ví điện tử MoMo</div>
                                                <div class="payment-description">Thanh toán qua ví điện tử MoMo</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Navigation Buttons -->
                                <div class="checkout-navigation">
                                    <a th:href="@{/checkout/shipping}" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                                    </a>
                                    <button type="submit" class="btn btn-primary" id="continueButton" disabled>
                                        Tiếp tục<i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <!-- Order Summary -->
                        <div class="order-summary">
                            <h3 class="order-summary-title">Thông tin đơn hàng</h3>
                            
                            <div class="order-summary-item">
                                <span class="order-summary-label">Tổng tiền hàng</span>
                                <span class="order-summary-value" th:text="${#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">
                                    500.000 VNĐ
                                </span>
                            </div>
                            
                            <div class="order-summary-item" th:if="${discount > 0}">
                                <span class="order-summary-label">Giảm giá</span>
                                <span class="order-summary-value" th:text="${#numbers.formatDecimal(discount, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">
                                    -50.000 VNĐ
                                </span>
                            </div>
                            
                            <div class="order-summary-item" th:if="${shippingCost != null}">
                                <span class="order-summary-label">Phí vận chuyển</span>
                                <span class="order-summary-value" th:text="${#numbers.formatDecimal(shippingCost, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">
                                    30.000 VNĐ
                                </span>
                            </div>
                            
                            <div class="order-summary-total">
                                <span class="order-summary-total-label">Tổng thanh toán</span>
                                <span class="order-summary-total-value" th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">
                                    480.000 VNĐ
                                </span>
                            </div>
                            
                            <!-- Items Preview -->
                            <div class="mt-4">
                                <p class="mb-2 fw-bold">Sản phẩm (<span th:text="${#lists.size(cartItems)}">3</span>)</p>
                                <div th:each="item : ${cartItems}" class="d-flex mb-2 pb-2 border-bottom">
                                    <div style="width: 50px; height: 50px;" class="me-2">
                                        <img th:if="${!#lists.isEmpty(item.product.productDetails) && item.product.productDetails[0].imageUrl != null}" 
                                             th:src="${item.product.productDetails[0].imageUrl}" 
                                             class="img-fluid" alt="Product Image">
                                        <img th:unless="${!#lists.isEmpty(item.product.productDetails) && item.product.productDetails[0].imageUrl != null}" 
                                             th:src="@{/assets/images/product-placeholder.jpg}" 
                                             class="img-fluid" alt="Product Image">
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="text-truncate" style="max-width: 200px;" th:text="${item.product.productName}">
                                            Tên sản phẩm dài có thể bị cắt
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <small th:text="${'SL: ' + item.quantity}">SL: 2</small>
                                            <span class="small fw-bold" th:text="${#numbers.formatDecimal(item.unitPrice * item.quantity, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">
                                                200.000 VNĐ
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <th:block layout:fragment="script">
        <!-- Inject error messages from server to JavaScript -->
        <script th:inline="javascript">
            // Error messages loaded from server-side
            const ERROR_MESSAGES = {
                INVALID_CARD_NUMBER: /*[[${@validationErrorMessages.getMessage('INVALID_CARD_NUMBER')}]]*/ 'Số thẻ không hợp lệ',
                INVALID_EXPIRATION_DATE: /*[[${@validationErrorMessages.getMessage('INVALID_EXPIRATION_DATE')}]]*/ 'Ngày hết hạn không hợp lệ (định dạng MM/YY)',
                INVALID_SECURITY_CODE: /*[[${@validationErrorMessages.getMessage('INVALID_SECURITY_CODE')}]]*/ 'Mã bảo mật không hợp lệ (3-4 chữ số)'
            };
        </script>
        
        <script>
            // Luhn algorithm to validate credit card numbers
            function isValidCreditCard(cardNumber) {
                // Remove spaces and dashes
                cardNumber = cardNumber.replace(/\s+/g, '').replace(/-/g, '');
                
                // Check if card number has 16 digits
                if (cardNumber.length !== 16) {
                    return false;
                }
                
                // Check if card number contains only digits
                if (!/^\d+$/.test(cardNumber)) {
                    return false;
                }
                
                // Luhn algorithm implementation
                let sum = 0;
                let doubleUp = false;
                
                // Process digits from right to left
                for (let i = cardNumber.length - 1; i >= 0; i--) {
                    let digit = parseInt(cardNumber.charAt(i));
                    
                    // Double every second digit
                    if (doubleUp) {
                        digit *= 2;
                        if (digit > 9) {
                            digit -= 9;
                        }
                    }
                    
                    sum += digit;
                    doubleUp = !doubleUp;
                }
                
                // If sum is divisible by 10, card number is valid
                return (sum % 10) === 0;
            }
            
            // Validate expiry date (not before current date)
            function isValidExpiryDate(expiryDate) {
                // Check format MM/YY
                if (!/^\d{2}\/\d{2}$/.test(expiryDate)) {
                    return false;
                }
                
                const parts = expiryDate.split('/');
                const month = parseInt(parts[0], 10);
                const year = parseInt('20' + parts[1], 10); // Convert to 4-digit year
                
                // Check if month is valid (1-12)
                if (month < 1 || month > 12) {
                    return false;
                }
                
                // Get current date
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1; // getMonth() returns 0-11
                
                // Check if expiry date is in the past
                if (year < currentYear || (year === currentYear && month <= currentMonth)) {
                    return false;
                }
                
                return true;
            }
            
            // Validate CVC (3 digits)
            function isValidCVC(cvc) {
                return /^\d{3}$/.test(cvc);
            }

            // Function to select a payment method - phải đặt ở phạm vi toàn cục để có thể gọi từ onclick
            function selectPaymentMethod(element, methodId) {
                console.log("Selected payment method: " + methodId); // Log để debug
                
                // Update radio button
                document.getElementById('payment-' + methodId).checked = true;
                
                // Remove selected class from all payment cards
                document.querySelectorAll('.payment-card').forEach(card => {
                    card.classList.remove('selected');
                    
                    // Remove selected badge if exists
                    const selectedBadge = card.querySelector('.selected-badge');
                    if (selectedBadge) {
                        selectedBadge.remove();
                    }
                });
                
                // Add selected class to clicked card
                element.classList.add('selected');
                
                // Add selected badge if it doesn't already have one
                if (!element.querySelector('.selected-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'selected-badge';
                    badge.textContent = 'Đã chọn';
                    element.appendChild(badge);
                }
                
                // Set the hidden input value
                document.getElementById('selectedPaymentMethod').value = methodId;
                
                // LUÔN Enable nút Continue bất kể phương thức thanh toán nào
                const continueButton = document.getElementById('continueButton');
                if (continueButton) {
                    continueButton.disabled = false;
                    console.log("Continue button enabled"); // Log để debug
                }
                
                // Xử lý các trường dữ liệu thẻ tín dụng dựa vào phương thức được chọn
                const creditCardFields = document.querySelectorAll('#credit-card-form input[required]');
                if (methodId === 'credit') {
                    // Giữ nguyên thuộc tính required cho thẻ tín dụng
                    creditCardFields.forEach(field => {
                        field.setAttribute('required', '');
                    });
                } else {
                    // Loại bỏ thuộc tính required cho các phương thức khác
                    creditCardFields.forEach(field => {
                        field.removeAttribute('required');
                    });
                }
                
                // Hide all payment additional forms
                document.querySelectorAll('.card-form').forEach(form => {
                    form.classList.remove('active');
                });
                
                // Show the appropriate form based on selected payment method
                if (methodId === 'credit') {
                    document.getElementById('credit-card-form').classList.add('active');
                } else if (methodId === 'bank') {
                    document.getElementById('bank-details').classList.add('active');
                }
            }
            
            document.addEventListener('DOMContentLoaded', function() {
                // Form validation
                const paymentForm = document.getElementById('paymentMethodForm');
                if (paymentForm) {
                    paymentForm.addEventListener('submit', function(e) {
                        // Get selected payment method
                        const selectedPaymentMethod = document.getElementById('selectedPaymentMethod').value;
                        
                        // Only validate credit card if credit card method is selected
                        if (selectedPaymentMethod === 'credit') {
                            // Get form fields
                            const cardNumber = document.getElementById('card-number').value.replace(/\s+/g, '');
                            const expiryDate = document.getElementById('expiry-date').value;
                            const cvc = document.getElementById('cvv').value;
                            
                            // Create validation error messages container if it doesn't exist
                            let errorContainer = document.getElementById('card-validation-errors');
                            if (!errorContainer) {
                                errorContainer = document.createElement('div');
                                errorContainer.id = 'card-validation-errors';
                                errorContainer.className = 'alert alert-danger mt-3';
                                document.getElementById('credit-card-form').prepend(errorContainer);
                            }
                            
                            // Reset error messages
                            errorContainer.innerHTML = '';
                            errorContainer.style.display = 'none';
                            
                            // Check all validations
                            let isValid = true;
                            const errors = [];
                            
                            // Validate card number
                            if (!isValidCreditCard(cardNumber)) {
                                isValid = false;
                                errors.push(ERROR_MESSAGES.INVALID_CARD_NUMBER);
                            }
                            
                            // Validate expiry date
                            if (!isValidExpiryDate(expiryDate)) {
                                isValid = false;
                                errors.push(ERROR_MESSAGES.INVALID_EXPIRATION_DATE);
                            }
                            
                            // Validate CVC
                            if (!isValidCVC(cvc)) {
                                isValid = false;
                                errors.push(ERROR_MESSAGES.INVALID_SECURITY_CODE);
                            }
                            
                            // If any validation fails, show error and prevent form submission
                            if (!isValid) {
                                e.preventDefault();
                                
                                // Display errors
                                errorContainer.innerHTML = '<ul class="mb-0">' + 
                                    errors.map(error => '<li>' + error + '</li>').join('') + 
                                    '</ul>';
                                errorContainer.style.display = 'block';
                                
                                // Scroll to error messages
                                errorContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }
                    });
                }
                
                // Format credit card number as user types
                const cardNumberInput = document.getElementById('card-number');
                if (cardNumberInput) {
                    cardNumberInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        // Limit to exactly 16 digits
                        value = value.substring(0, 16);
                        
                        let formattedValue = '';
                        
                        for (let i = 0; i < value.length; i++) {
                            if (i > 0 && i % 4 === 0) {
                                formattedValue += ' ';
                            }
                            formattedValue += value[i];
                        }
                        
                        e.target.value = formattedValue;
                        
                        // Update card icon based on first digit
                        const cardIcon = document.querySelector('.card-icon i');
                        if (cardIcon && value.length > 0) {
                            const firstDigit = value.charAt(0);
                            if (firstDigit === '4') {
                                cardIcon.className = 'fab fa-cc-visa';
                            } else if (firstDigit === '5') {
                                cardIcon.className = 'fab fa-cc-mastercard';
                            } else {
                                cardIcon.className = 'far fa-credit-card';
                            }
                        }
                    });
                    
                    // Add maxlength attribute to enforce the 19 character limit (16 digits + 3 spaces)
                    cardNumberInput.setAttribute('maxlength', '19');
                }
                
                // Format expiry date
                const expiryDateInput = document.getElementById('expiry-date');
                if (expiryDateInput) {
                    expiryDateInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        
                        if (value.length > 2) {
                            value = value.substring(0, 2) + '/' + value.substring(2, 4);
                        }
                        
                        e.target.value = value;
                    });
                }
                
                // Limit CVV to 3-4 digits
                const cvvInput = document.getElementById('cvv');
                if (cvvInput) {
                    cvvInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        e.target.value = value.substring(0, 3); // Limit to exactly 3 digits
                    });
                }
                
                // Pre-select the payment method if it was previously selected
                const selectedPaymentMethodId = document.getElementById('selectedPaymentMethod').value;
                if (selectedPaymentMethodId) {
                    const paymentCard = document.getElementById('payment-card-' + selectedPaymentMethodId);
                    if (paymentCard) {
                        selectPaymentMethod(paymentCard, selectedPaymentMethodId);
                    }
                }
            });
        </script>
    </th:block>
</body>
</html>